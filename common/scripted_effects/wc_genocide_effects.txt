# TODO: Give nickname, exclude child cultures, bonus speed for unraised armies, convertion game rules?

# Remove ongoing modifiers when title changes hands: on_title_gain, on_county_occupied
remove_genocide_modifiers = { 
    if = {
        limit = {
            has_variable = purge_population_current_progress
        }
        set_variable = { name = purge_population_current_progress value = 0 }
    }
    if = { 
        limit = { 
            has_county_modifier = ongoing_corruption
        }

        remove_county_modifier = ongoing_corruption
    }
    if = {
        limit = {
            has_county_modifier = ongoing_cleansing
        }

        remove_county_modifier = ongoing_cleansing
    }
    if = {
        limit = {
            has_county_modifier = ongoing_genocide
        }

        remove_county_modifier = ongoing_genocide
    }
}

add_corruption_modifier = {
    remove_corruption_modifiers = yes
    set_variable = {
        name = corruption_type
        value = flag:$MOD$
    }
    add_county_modifier = $MOD$
    remove_variable = corruption_type
}

remove_corruption_modifiers = {
    if = {
        limit = {
            has_county_modifier = county_corruption_light
        }

        remove_county_modifier = county_corruption_light
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_void
        }

        remove_county_modifier = county_corruption_void
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_arcane
        }

        remove_county_modifier = county_corruption_arcane
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_fel
        }

        remove_county_modifier = county_corruption_fel
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_life
        }

        remove_county_modifier = county_corruption_life
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_death
        }

        remove_county_modifier = county_corruption_death
    }
}

refresh_corruption_modifiers = { # Modifier scale only works when modifier is added, so we use this to remove modifier and re-add it
    if = {
        limit = {
            has_county_modifier = county_corruption_light
        }

        add_corruption_modifier = { MOD = county_corruption_light }
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_void
        }

        add_corruption_modifier = { MOD = county_corruption_void }
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_arcane
        }

        add_corruption_modifier = { MOD = county_corruption_arcane }
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_fel
        }

        add_corruption_modifier = { MOD = county_corruption_fel }
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_life
        }

        add_corruption_modifier = { MOD = county_corruption_life }
    }
    if = {
        limit = {
            has_county_modifier = county_corruption_death
        }

        add_corruption_modifier = { MOD = county_corruption_death }
    }
}

refresh_corruption_modifiers_all_counties = {
    every_held_title = {
        limit = {
            tier = tier_county
        }

        refresh_corruption_modifiers = yes
    }
}

remove_genocide_variables = {
    if = {
        limit = {
            has_variable = culture_genocided
            OR = {
                NOT = {
                    culture = holder.culture
                }
                always = $REMOVE$
            }
        }

        remove_variable = culture_genocided
    }

    if = {
        limit = {
            has_variable = faith_genocided
            OR = {
                NOT = {
                    faith = holder.faith
                }
                always = $REMOVE$
            }
        }

        remove_variable = faith_genocided
    }
}

corrupt_county_effect = {
    scope:county ?= {
        if = {
            limit = {
                OR = {
                    $ON_START$ = yes
                    AND = {
                        has_variable = purge_population_current_progress
                        var:purge_population_current_progress >= marshal_purge_population_threshold
                    }
                }
            }

            remove_genocide_modifiers = yes

            save_temporary_scope_value_as = {
                name = take_county
                value = yes
            }

            if = {
                limit = {
                    $ON_START$ = yes
                }

                save_temporary_scope_value_as = {
                    name = take_county
                    value = no
                }
            }

            set_county_culture = scope:councillor_liege.culture
            set_county_faith = scope:councillor_liege.faith

            if = {
                limit = {
                    can_corrupt_this_province_specific_trigger = { BEING = being_light MAGIC = light MOD = county_corruption_light }
                }

                add_corruption_modifier = { MOD = county_corruption_light }
            }
            else_if = {
                limit = {
                    can_corrupt_this_province_specific_trigger = { BEING = being_void MAGIC = shadow MOD = county_corruption_void }
                }

                add_corruption_modifier = { MOD = county_corruption_void }
            }
            else_if = {
                limit = {
                    can_corrupt_this_province_specific_trigger = { BEING = being_order MAGIC = order MOD = county_corruption_arcane }
                }

                add_corruption_modifier = { MOD = county_corruption_arcane }
            }
            else_if = {
                limit = {
                    can_corrupt_this_province_specific_trigger = { BEING = being_demon MAGIC = disorder MOD = county_corruption_fel }
                }

                add_corruption_modifier = { MOD = county_corruption_fel }
            }
            else_if = {
                limit = {
                    can_corrupt_this_province_specific_trigger = { BEING = being_life MAGIC = life MOD = county_corruption_life }
                }

                add_corruption_modifier = { MOD = county_corruption_life }
            }
            else_if = {
                limit = {
                    can_corrupt_this_province_specific_trigger = { BEING = being_undead MAGIC = death MOD = county_corruption_death }
                }

                add_corruption_modifier = { MOD = county_corruption_death }

                save_temporary_scope_value_as = {
                    name = take_county
                    value = no
                }

                if = {
                    limit = {
                        $ON_START$ = no
                    }
                    holder = {
                        raise_undead_by_basic_effect = { MASTER = scope:councillor_liege }
                    }
                }
            }

            if = {
                limit = {
                    $ON_START$ = no
                }

                genocide_common_effect = {
                    OPINION = yes
                    MULT = 3
                    MOD = minority_disapproves_of_genocide_population_opinion
                    TAKE_TITLE = scope:take_county
                }
            }
        }
    }
}

cleanse_county_effect = {
    scope:county ?= {
        if = { 
            limit = { 
                has_variable = purge_population_current_progress
                var:purge_population_current_progress >= marshal_purge_population_threshold
            }

            remove_genocide_modifiers = yes

            genocide_culture_effect = { MULT = 2 }
            genocide_faith_effect = { MOD = genocided_my_faith_opinion }
            genocide_common_effect = {
                OPINION = no
                MULT = 3
                MOD = minority_disapproves_of_genocide_population_opinion
                TAKE_TITLE = yes
            }
            remove_corruption_modifiers = yes

            add_county_modifier = {
                modifier = county_purged_modifier_3
            }

            trigger_event = { 
                on_action = on_reduce_purge_modifier_on_action
                days = 1200
            }

            # TODO: Should destroy random building, not sure if possible in CK3
        }
    }
}

purge_population_effect = {
    scope:county ?= {
        if = {
            limit = {
                has_variable = purge_population_current_progress
                var:purge_population_current_progress >= marshal_purge_population_threshold
            }

            remove_genocide_modifiers = yes

            genocide_culture_effect = { MULT = 2 }
            genocide_faith_effect = { MOD = genocided_my_faith_opinion }
            genocide_common_effect = {
                OPINION = yes
                MULT = 2
                MOD = minority_disapproves_of_genocide_population_opinion
                TAKE_TITLE = yes
            }

            add_county_modifier = {
                modifier = county_purged_modifier_3
            }

            trigger_event = {
                on_action = on_reduce_purge_modifier_on_action
                days = 1200
            }

            # TODO: Should destroy random building, not sure if possible in CK3
        }
    }
}

genocide_culture_effect = { 
    if = { 
        limit = { 
            allow_genocide_this_province_culture_trigger = yes
        }

        culture = {
            save_scope_as = old_culture
            change_cultural_acceptance = { 
                target = scope:councillor_liege.culture
                value = { 
                    value = -30
                    multiply = $MULT$
                }
                desc = cultural_acceptance_loss_purge_pupulation
            }
        }

        set_variable = { 
            name = culture_genocided
            value = scope:old_culture
        }


        set_county_culture = scope:councillor_liege.culture
    }
}

genocide_faith_effect = { 
    if = { 
        limit = { 
            allow_genocide_this_province_religion_trigger = yes
        }

        faith = { 
            save_scope_as = old_faith
            every_faith_ruler = {
                limit = {
                    NOT = {
                        target_is_liege_or_above = scope:councillor_liege

                    }
                }
                add_opinion = {
                    target = scope:councillor_liege
                    modifier = $MOD$
                }
            }
        }

        set_variable = { 
            name = faith_genocided
            value = scope:old_faith
        }


        set_county_faith = scope:councillor_liege.faith
    }
}

genocide_common_effect = { 
    scope:councillor_liege = {
        if = {
            limit = {
                $OPINION$ = yes
                any_vassal = {
                    has_vassal_stance = minority
                }
            }
            custom_tooltip = minority_disapproves_conversion
            hidden_effect = {
                every_vassal = {
                    limit = {
                        has_vassal_stance = minority
                    }
                    add_opinion = {
                        target = scope:councillor_liege
                        modifier = $MOD$
                    }
                }
            }
        }

        if = {
            limit = { government_has_flag = government_dark_frenzy_from_conversions }
            change_dark_frenzy_effect = { VALUE = dark_frenzy_from_convert_county }
        }
    }

    change_county_control = {
        value = -30
        multiply = $MULT$
    }
    change_development_level = {
        value = -10
        multiply = $MULT$
    }

    if = { # Take the title you just genocided
        limit = {
            $TAKE_TITLE$ = yes
            NOT = {
                holder = scope:councillor_liege
            }
            NOR = {
                holder.culture = scope:councillor_liege.culture
                holder.faith = scope:councillor_liege.faith
            }
        }

        holder = {
            save_temporary_scope_as = old_holder
        }

        create_title_and_vassal_change = {
            type = usurped
            add_claim_on_loss = yes
            save_scope_as = change
        }

        change_title_holder = {
            holder = scope:councillor_liege
            change = scope:change
            take_baronies = yes
        }

        resolve_title_and_vassal_change = scope:change

        scope:old_holder = { # If this was their only title they're included in the genocide
            if = {
                limit = {
                    is_ruler = no
                }

                death = {
                    death_reason = death_execution
                    killer = scope:councillor_liege
                }
            }
        }
    }
}