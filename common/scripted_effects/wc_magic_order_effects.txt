init_order_spells_effect = {
    add_to_global_variable_list = { name = order_spells target = flag:polymorph }
    add_to_global_variable_list = { name = order_spells target = flag:counterspell }
    add_to_global_variable_list = { name = order_spells target = flag:spellsteal }
}

cast_polymorph_effect = {
    if = {
        limit = { exists = var:polymorph_recipient }
        var:polymorph_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:polymorph
            exists = global_var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        if = {
            limit = {
                NOT = {
                    has_trait = polymorph
                }
            }

            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_polymorph_duration_days_value
                }
            }

            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_order_magic_resistance_dodge_value
            }

            random_list = {
                80 = {
                    add_trait = polymorph
                    save_scope_value_as = {
                        name = polymorph_prowess
                        value = {
                            value = prowess
                            subtract = 1
                            multiply = -1
                        }
                    }
                    trigger_event = {
                        id = wc_magic_spell_events.1001
                        days = wc_current_spell_duration
                    }
                    hidden_effect = {
                        add_prowess_skill = {
                            value = scope:polymorph_prowess
                        }
                        root = {
                            send_interface_toast = {
                                title = wc_spell_hit
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_polymorph_hit_tt
                            }
                        }
                    }
                }
                20 = {
                    custom_tooltip = wc_polymorph_resist_tt
                    modifier = {
                        is_alive = yes
                        add = scope:spell_dodge_chance
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_dodged
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_polymorph_dodge
                            }
                        }
                    }
                }
            }
        }
    }
}

cast_counterspell_effect = {
    if = {
        limit = { exists = var:counterspell_recipient }
        var:counterspell_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:counterspell
            exists = global_var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        if = {
            limit = {
                NOT = {
                    has_character_modifier = wc_counterspell_modifier
                }
            }

            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_counterspell_duration_days_value
                }
            }
            add_character_modifier = {
                modifier = wc_counterspell_modifier
                days = wc_current_spell_duration
            }
        }
    }
}

cast_spellsteal_effect = {
    if = {
        limit = { exists = var:spellsteal_recipient }
        var:spellsteal_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:spellsteal
            exists = global_var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        if = {
            limit = {
                NOT = {
                    has_character_modifier = wc_spellsteal_modifier
                }
            }

            random_list = {
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_summon_fire_elemental_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_summon_fire_elemental_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_summon_fire_elemental_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_summon_fire_elemental_modifier
                            days = wc_spell_summon_fire_elemental_duration_days_value
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_empowered_fire_elemental_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_empowered_fire_elemental_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_empowered_fire_elemental_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_empowered_fire_elemental_modifier
                            days = wc_spell_summon_fire_elemental_duration_days_value
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_animate_rage_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_animate_rage_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_animate_rage_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_animate_rage_modifier
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_backdraft_proc
                        NOT = {
                            root = {
                                has_character_modifier = wc_backdraft_proc
                            }
                        }
                    }
                    remove_character_modifier = wc_backdraft_proc
                    root = {
                        add_character_modifier = {
                            modifier = wc_backdraft_proc
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_flame_wall_good_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_flame_wall_good_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_flame_wall_good_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_flame_wall_good_modifier
                            days = wc_spell_flame_wall_duration_days_value
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_pyromania_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_pyromania_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_pyromania_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_pyromania_modifier
                            days = 365
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_cauterized_wound_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_cauterized_wound_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_cauterized_wound_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_cauterized_wound_modifier
                            days = wc_spell_cauterize_wound_duration_days_value
                        }
                    }
                }
                0 = {
                    modifier = {
                        add = 1
                        has_character_modifier = wc_counterspell_modifier
                        NOT = {
                            root = {
                                has_character_modifier = wc_counterspell_modifier
                            }
                        }
                    }
                    remove_character_modifier = wc_counterspell_modifier
                    root = {
                        add_character_modifier = {
                            modifier = wc_counterspell_modifier
                            days = wc_spell_counterspell_duration_days_value
                        }
                    }
                }
            }
        }
    }
}